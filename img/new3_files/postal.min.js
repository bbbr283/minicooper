define.nextId("postal");
(function(e,k){"function"===typeof define&&define.amd?define(["lodash"],function(l){return k(l,e)}):"object"===typeof module&&module.exports?module.exports=k(require("lodash"),this):e.postal=k(e._,e)})(this,function(e,k,l){function y(a,c,b){return function(d,e,f){d===a&&f.splice(e,1);0===f.length&&delete b[c]}}function v(a,c,b,d,e){var f=e&&e.headers||{};return function(e){if(g.resolver.compare(e.topic,a,f)){if(!f.resolverNoCache){var h=c[b]=c[b]||[];h.push(e);e.cacheKeys.push(b)}d&&d(e)}}}function w(a,
c){return{channel:g.SYSTEM_CHANNEL,topic:"subscription."+a,data:{event:"subscription."+a,channel:c.channel,topic:c.topic}}}function z(a,c){return"function"===typeof a?a:a?function(b){var d=0,h=0;e.each(a,function(f,e){d+=1;if("topic"===e&&c.compare(b.topic,a.topic,{resolverNoCache:!0})||"context"===e&&a.context===b._context||b[e]===a[e])h+=1});return d===h}:function(){return!0}}var A=k&&k.postal,x=k&&k._;x&&x!==e&&(e=e.noConflict());var n={configuration:e.extend({},{DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",
enableSystemMessages:!0,cacheKeyDelimiter:"|",autoCompactResolver:!1})},g=n.configuration,p=function(a,c){this.bus=c;this.channel=a||g.DEFAULT_CHANNEL};p.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})};p.prototype.publish=function(a,c,b){var d={};"string"===typeof a?(d.topic=a,d.data=c,a=b):(d=a,a=c);if("object"!==typeof d)throw Error("The first argument to ChannelDefinition.publish should be either an envelope object or a string topic.");
d.headers=e.extend(d.headers||{resolverNoCache:g.resolverNoCache});d.channel=this.channel;this.bus.publish(d,a)};var t=function(a,c,b){if(3!==arguments.length)throw Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===c.length)throw Error("Topics cannot be empty");this.channel=a;this.topic=c;this.callback=b;this.pipeline=[];this.cacheKeys=[];this._context=l},B=function(){var a;return function(c){if("string"===typeof c){var b=c===a;a=c}else b=
e.isEqual(c,a),a=e.extend({},c);return!b}},C=function(){var a=[];return function(c){var b=!e.some(a,function(a){return e.isEqual(c,a)});b&&a.push(c);return b}};t.prototype={catchError:function(a){var c=this.callback;this.callback=function(){try{c.apply(this,arguments)}catch(b){a(b,arguments[0])}};return this},defer:function(){return this.delay(0)},disposeAfter:function(a){if("number"!==typeof a||0>=a)throw Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");
var c=e.after(a,this.unsubscribe.bind(this));this.pipeline.push(function(a,d,e){e(a,d);c()});return this},distinct:function(){return this.constraint(new C)},distinctUntilChanged:function(){return this.constraint(new B)},invokeSubscriber:function(a,c){if(!this.inactive){var b=this,d=b.pipeline,e=d.length,f=b._context,g=-1,m=!1;e?(d=d.concat([b.callback]),function D(a,c){g+=1;g<e?d[g].call(f,a,c,D):(b.callback.call(f,a,c),m=!0)}(a,c,0)):(b.callback.call(f,a,c),m=!0);return m}},logError:function(){console&&
this.catchError(console.warn?console.warn:console.log);return this},once:function(){return this.disposeAfter(1)},subscribe:function(a){this.callback=a;return this},unsubscribe:function(){this.inactive||n.unsubscribe(this)},constraint:function(a){if("function"!==typeof a)throw Error("Predicate constraint must be a function");this.pipeline.push(function(c,b,d){a.call(this,c,b)&&d(c,b)});return this},constraints:function(a){var c=this;e.each(a,function(a){c.constraint(a)});return c},context:function(a){this._context=
a;return this},debounce:function(a,c){if("number"!==typeof a)throw Error("Milliseconds must be a number");var b={};!0===!!c&&(b.leading=!0,b.trailing=!1);this.pipeline.push(e.debounce(function(a,b,c){c(a,b)},a,b));return this},delay:function(a){if("number"!==typeof a)throw Error("Milliseconds must be a number");this.pipeline.push(function(c,b,d){setTimeout(function(){d(c,b)},a)});return this},throttle:function(a){if("number"!==typeof a)throw Error("Milliseconds must be a number");this.pipeline.push(e.throttle(function(a,
b,d){d(a,b)},a));return this}};g.resolver={cache:{},regex:{},enableCache:!0,compare:function(a,c,b){var d,h=c+g.cacheKeyDelimiter+a;var f=this.cache[h];b=b||{};b=this.enableCache&&!b.resolverNoCache;if(!0===f)return f;if(-1===a.indexOf("#")&&-1===a.indexOf("*"))return f=c===a,b&&(this.cache[h]=f),f;(f=this.regex[a])||(f="^"+e.map(a.split("."),function(a){var b="";d&&(b="#"!==d?"\\.\\b":"\\b");d=a;return"#"===a?b+"[\\s\\S]*":"*"===a?b+"[^.]+":b+a}).join("")+"$",f=this.regex[a]=new RegExp(f));f=f.test(c);
b&&(this.cache[h]=f);return f},reset:function(){this.cache={};this.regex={}},purge:function(a){var c=this,b=g.cacheKeyDelimiter,d=function(d,e){var f=e.split(b);d=f[0];f=f[1];"undefined"!==typeof a.topic&&a.topic!==d||"undefined"!==typeof a.binding&&a.binding!==f||delete c.cache[e]},h=function(a,d){a=d.split(b);0===n.getSubscribersFor({topic:a[0]}).length&&delete c.cache[d]};"undefined"===typeof a?this.reset():e.each(this.cache,!0===a.compact?h:d)}};var q=0,u=[],r=0,E=w.bind(l,"created"),F=w.bind(l,
"removed");e.extend(n,{cache:{},subscriptions:{},wireTaps:[],ChannelDefinition:p,SubscriptionDefinition:t,channel:function(a){return new p(a,this)},addWireTap:function(a){var c=this;c.wireTaps.push(a);return function(){var b=c.wireTaps.indexOf(a);-1!==b&&c.wireTaps.splice(b,1)}},noConflict:function(){if("undefined"===typeof window||"undefined"!==typeof window&&"function"===typeof define&&define.amd)throw Error("noConflict can only be used in browser clients which aren't using AMD modules");k.postal=
A;return this},getSubscribersFor:function(a){var c=[];e.each(this.subscriptions,function(b){e.each(b,function(b){c=c.concat(e.filter(b,z(a,g.resolver)))})});return c},publish:function(a,c){++q;var b=a.channel=a.channel||g.DEFAULT_CHANNEL,d=a.topic;a.timeStamp=new Date;this.wireTaps.length&&e.each(this.wireTaps,function(b){b(a.data,a,q)});var h=b+g.cacheKeyDelimiter+d,f=this.cache[h],k=0,m=0;if(f)e.each(f,function(b){b.invokeSubscriber(a.data,a)?m++:k++});else{var l=v(d,this.cache,h,function(b){b.invokeSubscriber(a.data,
a)?m++:k++},a);e.each(this.subscriptions[b],function(a){e.each(a,l)})}if(0===--q)for(;u.length;)n.unsubscribe(u.shift());c&&c({activated:m,skipped:k})},reset:function(){this.unsubscribeFor();g.resolver.reset();this.subscriptions={};this.cache={}},subscribe:function(a){var c=this.subscriptions,b=new t(a.channel||g.DEFAULT_CHANNEL,a.topic,a.callback);a=c[b.channel];var d=b.channel.length;a||(a=c[b.channel]={});(a=c[b.channel][b.topic])||(a=c[b.channel][b.topic]=[]);a.push(b);var h=this.cache;e.each(e.keys(h),
function(a){a.substr(0,d)===b.channel&&v(a.split(g.cacheKeyDelimiter)[1],h,a)(b)});g.enableSystemMessages&&this.publish(E(b));return b},unsubscribe:function(){for(var a=arguments.length,c=0,b,d,h,f;c<a;c++){b=arguments[c];b.inactive=!0;if(q){u.push(b);break}if(h=(d=this.subscriptions[b.channel])&&d[b.topic]){var k=h.length;for(f=0;f<k;){if(h[f]===b){h.splice(f,1);break}f+=1}0===h.length&&(delete d[b.topic],e.keys(d).length||delete this.subscriptions[b.channel]);if(b.cacheKeys&&b.cacheKeys.length)for(;d=
b.cacheKeys.pop();)e.each(this.cache[d],y(b,d,this.cache));"function"===typeof g.resolver.purge&&(d=!0===g.autoCompactResolver?0:"number"===typeof g.autoCompactResolver?g.autoCompactResolver-1:!1,0<=d&&r===d?(g.resolver.purge({compact:!0}),r=0):0<=d&&r<d&&(r+=1))}g.enableSystemMessages&&this.publish(F(b))}},unsubscribeFor:function(a){this.subscriptions&&(a=this.getSubscribersFor(a),this.unsubscribe.apply(this,a))}});if(k&&Object.prototype.hasOwnProperty.call(k,"__postalReady__")&&e.isArray(k.__postalReady__))for(;k.__postalReady__.length;)k.__postalReady__.shift().onReady(n);
return n});